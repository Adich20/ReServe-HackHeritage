<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart - ReServe</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Dark Mode Initialization -->
  <script>
    (function () {
      try {
        const ls = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (ls === 'dark' || (!ls && systemDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (e) {}
    })();
  </script>

  <style>
    :root {
      --color-primary:#2ECC71;
      --color-secondary:#5DADE2;
      --color-accent1:#F39C12;
      --color-accent2:#9B59B6;
      --color-neutral:#497096;
      --color-neutral-80:#415b76;
      --color-surface:#171717;
      --ring: 0 0 0 4px rgba(43, 197, 107, 0.2);
    }
    #map {
      height: 250px;
      width: 100%;
      border-radius: 15px;
    }
    .dark #map {
      border: 1px solid #374151;
    }
  </style>
</head>
<body class="antialiased bg-gray-50 text-neutral dark:bg-gray-900 dark:text-gray-100 transition-colors">

  <!-- Navbar -->
  <header class="sticky top-0 z-40 border-b border-gray-100/70 bg-white/80 backdrop-blur dark:bg-gray-800/80 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <!-- Brand -->
        <a href="index.html" class="flex items-center gap-2">
          <img src="logo.png" alt="ReServe logo" class="h-10 w-10 rounded-md shadow" />
          <span class="font-bold text-lg tracking-tight"><span class="text-white dark:text-gray-100">Re</span><span class="text-[color:var(--color-primary)]">Serve</span></span>
        </a>

        <!-- Nav Links -->
        <nav class="hidden md:flex items-center gap-6">
          <a href="index.html" class="hover:text-primary transition">Home</a>
          <a href="search.html" class="hover:text-primary transition">Search Food</a>
          <a id="cartLink" href="cart.html" class="hover:text-primary transition">Cart</a>
          <a href="profile.html" class="hover:text-primary transition">Profile</a>
        </nav>

        <!-- Dark mode toggle -->
        <button id="darkToggle" aria-label="Toggle dark mode"
          class="px-3 py-2 rounded-lg border border-gray-200 hover:border-primary hover:text-primary transition dark:border-gray-700">
          ðŸŒ™
        </button>
      </div>
    </div>
  </header>

  <!-- Cart Layout -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid md:grid-cols-3 gap-6">
    <!-- Left: Cart & Receipt -->
    <section class="md:col-span-2 space-y-6">
      <!-- Cart Items -->
      <div class="rounded-2xl border border-gray-200 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 shadow-sm">
        <h2 class="text-xl font-bold text-[color:var(--color-primary)] mb-4">Your Cart</h2>
        <div id="cart-items" class="space-y-3"></div>
      </div>

      <!-- Receipt -->
      <div class="rounded-2xl border border-gray-200 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 shadow-sm">
        <h2 class="text-xl font-bold text-primary mb-4">Receipt</h2>
        <div id="receipt" class="space-y-2 text-sm"></div>
        <button id="confirmPay" class="w-full mt-6 px-4 py-3 rounded-lg bg-[color:var(--color-primary)] text-white font-semibold hover:bg-[color:#27ae60] transition">Confirm & Pay</button>
      </div>
    </section>

    <!-- Right: Address & Map -->
    <aside class="rounded-2xl border border-gray-200 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 shadow-sm">
      <h2 class="text-xl font-bold text-primary mb-4">Delivery Location</h2>
      <input type="text" id="address" placeholder="Enter delivery address"
        class="w-full rounded-lg border border-gray-200 p-3 mb-4 focus:ring-2 focus:ring-[color:var(--color-primary)]/40 dark:border-gray-700 dark:bg-gray-900" />
      <div id="map"></div>
      <button id="saveAddress" class="w-full mt-4 px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-[color:#27ae60] transition">Save Address</button>
    </aside>
  </main>

  <!-- Map Script -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Map init
    const map = L.map('map').setView([22.5726, 88.3639], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let marker;
    let currentLatLng;

    // Function to fetch readable address using Nominatim API
    async function getReadableAddress(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await response.json();
        return data.display_name || `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
      } catch (error) {
        console.error('Error fetching address:', error);
        return `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
      }
    }

    // Map click event to set marker and update address
    map.on('click', async function(e) {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);
      currentLatLng = e.latlng;
      const address = await getReadableAddress(e.latlng.lat, e.latlng.lng);
      document.getElementById('address').value = address;
    });

    // Save address
    document.getElementById('saveAddress').addEventListener('click', () => {
      const addressInput = document.getElementById('address').value.trim();
      if (addressInput && addressInput !== 'Enter delivery address' && currentLatLng) {
        const savedAddress = {
          address: addressInput,
          lat: currentLatLng.lat,
          lng: currentLatLng.lng
        };
        localStorage.setItem('savedAddress', JSON.stringify(savedAddress));
        alert('Address saved successfully!');
      } else {
        alert('Please select a location on the map to save a valid address.');
      }
    });

    // Load cart from localStorage
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    // Render cart and receipt
    function renderCart() {
      const cartDiv = document.getElementById("cart-items");
      const receiptDiv = document.getElementById("receipt");
      cartDiv.innerHTML = "";
      receiptDiv.innerHTML = "";
      let subtotal = 0;

      // Render cart items
      cart.forEach(item => {
        cartDiv.innerHTML += `
          <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
            <span>${item.name} (x${item.quantity})</span>
            <span>â‚¹${item.price * item.quantity}</span>
          </div>`;
        receiptDiv.innerHTML += `<p class="flex justify-between"><span>${item.name} x${item.quantity}</span><span>â‚¹${item.price * item.quantity}</span></p>`;
        subtotal += item.price * item.quantity;
      });

      // Calculate payment details
      const taxRate = 0.05; // 5% tax
      const deliveryFee = 40; // Fixed delivery fee
      const tax = subtotal * taxRate;
      const total = subtotal + tax + deliveryFee;

      // Render payment details in receipt
      receiptDiv.innerHTML += `
        <hr class="my-2 border-gray-200 dark:border-gray-700">
        <p class="flex justify-between"><span>Subtotal</span><span>â‚¹${subtotal.toFixed(2)}</span></p>
        <p class="flex justify-between"><span>Tax (5%)</span><span>â‚¹${tax.toFixed(2)}</span></p>
        <p class="flex justify-between"><span>Delivery Fee</span><span>â‚¹${deliveryFee.toFixed(2)}</span></p>
        <p class="flex justify-between font-bold text-accent1"><span>Total</span><span>â‚¹${total.toFixed(2)}</span></p>
      `;
    }

    // Update cart link with item count
    function updateCartLink() {
      const cartLink = document.getElementById('cartLink');
      if (cartLink) {
        cartLink.innerHTML = 'Cart';
        const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0, 0);
        if (cartCount > 0) {
          cartLink.innerHTML += ` <span class="ml-1 text-xs bg-[color:var(--color-primary)] text-white rounded-full px-2 py-1">${cartCount}</span>`;
        }
      }
    }

    // Initial render
    renderCart();
    updateCartLink();

    // Confirm & Pay action
    document.getElementById('confirmPay').addEventListener('click', () => {
      const address = localStorage.getItem('savedAddress');
      if (!address) {
        alert('Please save a delivery address before proceeding to payment.');
        return;
      }
      alert('Processing payment...'); // Replace with your payment logic
    });

    // Dark toggle
    document.getElementById('darkToggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });
  </script>
</body>
</html>
